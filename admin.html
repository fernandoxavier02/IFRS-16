<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Engine IFRS 16</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/theme-neon.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            z-index: 10;
        }
        .admin-header {
            background: linear-gradient(135deg, rgba(184, 41, 221, 0.2), rgba(0, 212, 255, 0.1));
            border: 1px solid rgba(184, 41, 221, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }
        .admin-header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .admin-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .admin-section {
            background: linear-gradient(135deg, var(--dark-card) 0%, rgba(10, 22, 40, 0.9) 100%);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .admin-section:hover {
            border-color: rgba(0, 212, 255, 0.3);
        }
        .section-header {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--neon-cyan);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .admin-input {
            background: var(--dark-input);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 0.9rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        .admin-input:focus {
            outline: none;
            border-color: var(--neon-blue);
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.1);
        }
        .admin-input::placeholder {
            color: var(--text-muted);
        }
        .admin-select {
            background: var(--dark-input);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 0.9rem;
            width: 100%;
        }
        .admin-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .admin-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
        }
        .admin-table thead {
            background: rgba(0, 212, 255, 0.1);
        }
        .admin-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--neon-cyan);
            border-bottom: 1px solid var(--dark-border);
        }
        .admin-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(26, 35, 50, 0.5);
            color: var(--text-secondary);
        }
        .admin-table tbody tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-active { background: rgba(0, 255, 136, 0.15); color: var(--success); }
        .status-inactive { background: rgba(255, 68, 102, 0.15); color: var(--error); }
        .status-suspended { background: rgba(255, 170, 0, 0.15); color: var(--warning); }
        .result-box {
            margin-top: 16px;
            padding: 16px;
            border-radius: 10px;
        }
        .result-success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--success);
        }
        .result-error {
            background: rgba(255, 68, 102, 0.1);
            border: 1px solid rgba(255, 68, 102, 0.3);
            color: var(--error);
        }
        .result-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: var(--neon-cyan);
        }
    </style>
</head>
<body>
    <!-- Circuit Background -->
    <div class="circuit-bg"></div>

    <div class="admin-container fade-in">
        <!-- Header -->
        <div class="admin-header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <img src="logo/Gemini_Generated_Image_rvkfr5rvkfr5rvkf.png" alt="FX Studio AI" style="height: 50px; filter: drop-shadow(0 0 10px rgba(184, 41, 221, 0.4));">
                <div>
                    <h1>Painel Administrativo</h1>
                    <p>Engine IFRS 16 - Gerenciamento de Licen√ßas</p>
                </div>
            </div>
            <div id="headerLogoutSection" style="display: none;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="color: var(--text-secondary); font-size: 0.85rem;">Logado como: <strong id="headerLoggedUser" style="color: var(--neon-cyan);"></strong></span>
                    <button onclick="fazerLogout()" class="btn-danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        Sair
                    </button>
                </div>
            </div>
        </div>

        <!-- Configura√ß√£o / Login -->
        <div class="admin-section">
            <h2 class="section-header">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Configura√ß√£o e Login
            </h2>
            <div id="loginSection">
                <div class="result-box result-info" style="margin-bottom: 16px; margin-top: 0;">
                    <p style="font-size: 0.85rem;"><strong>URL da API:</strong> <code id="apiUrlDisplay" style="font-family: monospace; font-size: 0.8rem;"></code></p>
                </div>
                <div class="admin-grid">
                    <div>
                        <label class="admin-label">Email</label>
                        <input type="email" id="adminEmail" value="fernandocostaxavier@gmail.com" placeholder="admin@ifrs16.local" class="admin-input">
                    </div>
                    <div>
                        <label class="admin-label">Senha</label>
                        <input type="password" id="adminPassword" placeholder="Digite a senha" class="admin-input">
                    </div>
                </div>
                <div style="margin-top: 16px; display: flex; align-items: center; gap: 16px;">
                    <button onclick="fazerLogin()" class="btn-neon btn-neon-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        Fazer Login
                    </button>
                    <span id="connectionStatus"></span>
                </div>
                <input type="hidden" id="apiUrl" value="">
            </div>
            <div id="loggedInSection" style="display: none;">
                <div class="result-box result-success">
                    <p style="font-weight: 600;">Logado como: <span id="loggedUser" style="color: var(--neon-cyan);"></span></p>
                    <button onclick="fazerLogout()" class="btn-danger" style="margin-top: 12px;">Sair</button>
                </div>
            </div>
        </div>

        <!-- Gerar Nova Licen√ßa -->
        <div class="admin-section">
            <h2 class="section-header">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                Gerar Nova Licen√ßa
            </h2>
            <div class="admin-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                <div>
                    <label class="admin-label">Nome do Cliente</label>
                    <input type="text" id="customerName" placeholder="Nome completo" class="admin-input">
                </div>
                <div>
                    <label class="admin-label">Email</label>
                    <input type="email" id="customerEmail" placeholder="email@exemplo.com" class="admin-input">
                </div>
                <div>
                    <label class="admin-label">Tipo de Licen√ßa</label>
                    <select id="licenseType" class="admin-select">
                        <option value="trial">Trial (demonstra√ß√£o)</option>
                        <option value="basic">Basic</option>
                        <option value="pro" selected>Pro</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                <div>
                    <label class="admin-label">Dura√ß√£o (meses)</label>
                    <input type="number" id="durationMonths" placeholder="Vazio = permanente" min="1" class="admin-input">
                </div>
            </div>
            <button onclick="gerarLicenca()" class="btn-neon btn-neon-sm" style="margin-top: 16px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Gerar Licen√ßa
            </button>
            <div id="generateResult"></div>
        </div>

        <!-- A√ß√µes em Licen√ßa -->
        <div class="admin-section">
            <h2 class="section-header">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                A√ß√µes em Licen√ßa
            </h2>
            <div class="admin-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div>
                    <label class="admin-label">Chave da Licen√ßa</label>
                    <input type="text" id="actionKey" placeholder="FX2025-IFRS16-XXX-XXXXX" class="admin-input" style="text-transform: uppercase;">
                </div>
                <div>
                    <label class="admin-label">Motivo (para revoga√ß√£o)</label>
                    <input type="text" id="revokeReason" placeholder="Opcional" class="admin-input">
                </div>
                <div style="display: flex; align-items: flex-end; gap: 8px; flex-wrap: wrap;">
                    <button onclick="revogarLicenca()" class="btn-danger">Revogar</button>
                    <button onclick="reativarLicenca()" class="btn-neon-outline btn-neon-sm">Reativar</button>
                    <button onclick="buscarLicenca()" class="btn-neon btn-neon-sm">Buscar</button>
                </div>
            </div>
            <div id="actionResult"></div>
        </div>

        <!-- Lista de Licen√ßas -->
        <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 class="section-header" style="margin-bottom: 0;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    Licen√ßas Cadastradas
                </h2>
                <button onclick="listarLicencas()" class="btn-neon btn-neon-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    Atualizar
                </button>
            </div>
            <div id="licenseList" style="overflow-x: auto;">
                <p style="color: var(--text-muted); text-align: center; padding: 40px 20px;">Clique em "Atualizar" para carregar as licen√ßas</p>
            </div>
        </div>

        <!-- Lista de Usu√°rios -->
        <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 class="section-header" style="margin-bottom: 0;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Usu√°rios Cadastrados
                </h2>
                <button onclick="listarUsuarios()" class="btn-neon-outline btn-neon-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    Atualizar
                </button>
            </div>
            <div id="userList" style="overflow-x: auto;">
                <p style="color: var(--text-muted); text-align: center; padding: 40px 20px;">Clique em "Atualizar" para carregar os usu√°rios</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-neon">
            <p>¬© 2025 FX Studio AI - Painel Administrativo Engine IFRS 16</p>
            <p style="margin-top: 8px; font-size: 0.75rem;">v1.1.1</p>
        </div>
    </div>

    <script>
        // Detectar URL da API automaticamente
        const getApiUrl = () => {
            const hostname = window.location.hostname;
            
            // Firebase Hosting / Dom√≠nio customizado (produ√ß√£o) - Backend no Cloud Run
            if (
                hostname.includes('fxstudioai.com') ||
                hostname.includes('web.app') ||
                hostname.includes('firebaseapp.com')
            ) {
                return 'https://ifrs16-backend-1051753255664.us-central1.run.app';
            }
            
            // Desenvolvimento local
            return 'http://localhost:8000';
        };
        
        const API_URL = getApiUrl();
        
        let jwtToken = null;
        let loggedUser = null;

        // Verificar se h√° token salvo no localStorage
        function checkStoredToken() {
            const storedToken = localStorage.getItem('ifrs16_auth_token');
            const storedUserType = localStorage.getItem('ifrs16_user_type');
            
            if (storedToken && storedUserType === 'admin') {
                jwtToken = storedToken;
                // Tentar obter dados do usu√°rio
                loadUserData();
            }
        }

        // Carregar dados do usu√°rio logado
        async function loadUserData() {
            if (!jwtToken) return;
            
            try {
                const response = await fetch(`${API_URL}/api/auth/admin/me`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    loggedUser = data.username || data.email;
                    showLoggedInState();
                } else if (response.status === 401) {
                    // Token inv√°lido ou expirado
                    clearAuth();
                }
            } catch (e) {
                console.error('Erro ao carregar dados do usu√°rio:', e);
            }
        }

        // Mostrar estado logado
        function showLoggedInState() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('loggedInSection').style.display = 'block';
            document.getElementById('loggedUser').textContent = loggedUser;
            document.getElementById('headerLogoutSection').style.display = 'block';
            document.getElementById('headerLoggedUser').textContent = loggedUser;
            document.getElementById('apiUrl').value = API_URL;
        }

        // Limpar autentica√ß√£o
        function clearAuth() {
            jwtToken = null;
            loggedUser = null;
            localStorage.removeItem('ifrs16_auth_token');
            localStorage.removeItem('ifrs16_user_type');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('loggedInSection').style.display = 'none';
            document.getElementById('headerLogoutSection').style.display = 'none';
        }

        function getConfig() {
            return {
                apiUrl: API_URL
            };
        }
        
        // Verificar token ao carregar a p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiUrl').value = API_URL;
            document.getElementById('apiUrlDisplay').textContent = API_URL;
            checkStoredToken();
        });

        async function fazerLogin() {
            const status = document.getElementById('connectionStatus');
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                status.innerHTML = '<span class="text-red-600">‚ùå Preencha email e senha</span>';
                return;
            }

            status.innerHTML = '<span class="text-gray-500">Conectando...</span>';

            try {
                console.log('üîç DEBUG LOGIN:', {
                    url: `${API_URL}/api/auth/admin/login`,
                    email: email
                });

                const response = await fetch(`${API_URL}/api/auth/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                console.log('üì• RESPOSTA:', {
                    status: response.status,
                    ok: response.ok,
                    detail: data.detail
                });

                if (response.ok && data.access_token) {
                    jwtToken = data.access_token;
                    
                    // Salvar token no localStorage
                    localStorage.setItem('ifrs16_auth_token', jwtToken);
                    localStorage.setItem('ifrs16_user_type', 'admin');
                    
                    // Obter dados do usu√°rio
                    try {
                        const meResponse = await fetch(`${API_URL}/api/auth/admin/me`, {
                            headers: {
                                'Authorization': `Bearer ${jwtToken}`
                            }
                        });
                        if (meResponse.ok) {
                            const meData = await meResponse.json();
                            loggedUser = meData.username || meData.email || email;
                        } else {
                            loggedUser = email;
                        }
                    } catch (e) {
                        console.error('Erro ao obter dados do usu√°rio:', e);
                        loggedUser = email;
                    }
                    
                    showLoggedInState();
                    status.innerHTML = '<span class="text-green-600">‚úÖ Login realizado com sucesso!</span>';
                } else {
                    status.innerHTML = `<span class="text-red-600">‚ùå ${data.detail || 'Erro no login'}</span>`;
                }
            } catch (e) {
                console.error('Erro no login:', e);
                status.innerHTML = '<span class="text-red-600">‚ùå Erro de conex√£o. Verifique se a API est√° rodando.</span>';
            }
        }

        function fazerLogout() {
            clearAuth();
            document.getElementById('connectionStatus').innerHTML = '';
            document.getElementById('adminPassword').value = '';
            
            // Limpar resultados das se√ß√µes
            document.getElementById('generateResult').innerHTML = '';
            document.getElementById('actionResult').innerHTML = '';
            document.getElementById('licenseList').innerHTML = '<p class="text-gray-500 text-center py-8">Clique em "Atualizar" para carregar as licen√ßas</p>';
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            if (!jwtToken) {
                throw new Error('Fa√ßa login primeiro');
            }

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                }
            };
            if (body) options.body = JSON.stringify(body);
            
            const url = `${API_URL}${endpoint}`;
            console.log(`üåê API Call: ${method} ${url}`, body ? { body } : '');
            
            const response = await fetch(url, options);
            const data = await response.json();
            
            // Se token expirado, limpar autentica√ß√£o
            if (response.status === 401) {
                clearAuth();
                throw new Error('Token expirado. Fa√ßa login novamente.');
            }
            
            return { response, data };
        }

        async function testarConexao() {
            const status = document.getElementById('connectionStatus');
            try {
                const { response, data } = await apiCall('/api/auth/admin/me');
                if (response.ok) {
                    status.innerHTML = '<span class="text-green-600">‚úÖ Conectado</span>';
                } else {
                    status.innerHTML = '<span class="text-red-600">‚ùå Erro</span>';
                }
            } catch (e) {
                status.innerHTML = '<span class="text-red-600">‚ùå Fa√ßa login primeiro</span>';
            }
        }

        async function gerarLicenca() {
            const result = document.getElementById('generateResult');
            result.innerHTML = '<span class="text-gray-500">Gerando...</span>';
            
            try {
                if (!jwtToken) {
                    result.innerHTML = '<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå Fa√ßa login primeiro</div>';
                    return;
                }

                const body = {
                    customer_name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    license_type: document.getElementById('licenseType').value,
                };
                
                const months = document.getElementById('durationMonths').value;
                if (months) body.duration_months = parseInt(months);
                
                const { response, data } = await apiCall('/api/admin/generate-license', 'POST', body);
                
                if (response.ok && data.success) {
                    result.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded p-4">
                            <p class="text-green-800 font-semibold">‚úÖ Licen√ßa gerada com sucesso!</p>
                            <p class="mt-2"><strong>Chave:</strong> <code class="bg-gray-100 px-2 py-1 rounded">${data.license.key}</code></p>
                            <p><strong>Cliente:</strong> ${data.license.customer_name}</p>
                            <p><strong>Tipo:</strong> ${data.license.license_type}</p>
                            <p><strong>Expira:</strong> ${data.license.expires_at ? new Date(data.license.expires_at).toLocaleDateString('pt-BR') : 'Nunca'}</p>
                        </div>
                    `;
                } else {
                    if (response.status === 401) {
                        fazerLogout();
                        result.innerHTML = '<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå Token expirado. Fa√ßa login novamente.</div>';
                    } else {
                        result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå ${data.detail || 'Erro ao gerar'}</div>`;
                    }
                }
            } catch (e) {
                result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå ${e.message || 'Erro de conex√£o'}</div>`;
            }
        }

        async function revogarLicenca() {
            const key = document.getElementById('actionKey').value;
            const reason = document.getElementById('revokeReason').value;
            const result = document.getElementById('actionResult');
            
            if (!key) {
                result.innerHTML = '<div class="text-red-600">Digite a chave da licen√ßa</div>';
                return;
            }
            
            try {
                const { response, data } = await apiCall('/api/admin/revoke-license', 'POST', { key, reason });
                
                if (response.ok && data.success) {
                    result.innerHTML = `<div class="bg-green-50 border border-green-200 rounded p-4 text-green-800">‚úÖ ${data.message}</div>`;
                } else {
                    result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå ${data.detail || 'Erro'}</div>`;
                }
            } catch (e) {
                result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå Erro de conex√£o</div>`;
            }
        }

        async function reativarLicenca() {
            const key = document.getElementById('actionKey').value;
            const result = document.getElementById('actionResult');
            
            if (!key) {
                result.innerHTML = '<div class="text-red-600">Digite a chave da licen√ßa</div>';
                return;
            }
            
            try {
                const { response, data } = await apiCall('/api/admin/reactivate-license', 'POST', { key });
                
                if (response.ok && data.success) {
                    result.innerHTML = `<div class="bg-green-50 border border-green-200 rounded p-4 text-green-800">‚úÖ ${data.message}</div>`;
                } else {
                    result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå ${data.detail || 'Erro'}</div>`;
                }
            } catch (e) {
                result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå Erro de conex√£o</div>`;
            }
        }

        async function buscarLicenca() {
            const key = document.getElementById('actionKey').value;
            const result = document.getElementById('actionResult');
            
            if (!key) {
                result.innerHTML = '<div class="text-red-600">Digite a chave da licen√ßa</div>';
                return;
            }
            
            try {
                const { response, data } = await apiCall(`/api/admin/license/${key}`);
                
                if (response.ok) {
                    result.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded p-4">
                            <p class="font-semibold text-blue-800 mb-2">Detalhes da Licen√ßa</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <p><strong>Chave:</strong> ${data.key}</p>
                                <p><strong>Cliente:</strong> ${data.customer_name}</p>
                                <p><strong>Email:</strong> ${data.email}</p>
                                <p><strong>Tipo:</strong> ${data.license_type}</p>
                                <p><strong>Status:</strong> <span class="${data.status === 'active' ? 'text-green-600' : 'text-red-600'}">${data.status}</span></p>
                                <p><strong>Revogada:</strong> ${data.revoked ? 'Sim' : 'N√£o'}</p>
                                <p><strong>Criada:</strong> ${new Date(data.created_at).toLocaleDateString('pt-BR')}</p>
                                <p><strong>Expira:</strong> ${data.expires_at ? new Date(data.expires_at).toLocaleDateString('pt-BR') : 'Nunca'}</p>
                                <p><strong>√öltima valida√ß√£o:</strong> ${data.last_validation ? new Date(data.last_validation).toLocaleString('pt-BR') : 'Nunca'}</p>
                                <p><strong>Ativa√ß√µes:</strong> ${data.current_activations}/${data.max_activations}</p>
                            </div>
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå ${data.detail || 'Licen√ßa n√£o encontrada'}</div>`;
                }
            } catch (e) {
                result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå Erro de conex√£o</div>`;
            }
        }

        async function listarLicencas() {
            const container = document.getElementById('licenseList');
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Carregando...</p>';
            
            try {
                const { response, data } = await apiCall('/api/admin/licenses');
                
                if (response.ok) {
                    if (data.licenses.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma licen√ßa cadastrada</p>';
                        return;
                    }
                    
                    let html = `
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-3 py-2 text-left">Chave</th>
                                    <th class="px-3 py-2 text-left">Cliente</th>
                                    <th class="px-3 py-2 text-center">Tipo</th>
                                    <th class="px-3 py-2 text-center">Status</th>
                                    <th class="px-3 py-2 text-center">Expira</th>
                                    <th class="px-3 py-2 text-center">√öltima Valida√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.licenses.forEach((lic, idx) => {
                        const statusClass = lic.status === 'active' ? 'bg-green-100 text-green-800' : 
                                          lic.status === 'suspended' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                        html += `
                            <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                <td class="px-3 py-2 font-mono text-xs">${lic.key}</td>
                                <td class="px-3 py-2">${lic.customer_name}</td>
                                <td class="px-3 py-2 text-center">${lic.license_type}</td>
                                <td class="px-3 py-2 text-center"><span class="px-2 py-1 rounded text-xs ${statusClass}">${lic.status}</span></td>
                                <td class="px-3 py-2 text-center">${lic.expires_at ? new Date(lic.expires_at).toLocaleDateString('pt-BR') : '-'}</td>
                                <td class="px-3 py-2 text-center text-xs">${lic.last_validation ? new Date(lic.last_validation).toLocaleString('pt-BR') : '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    html += `<p class="text-sm text-gray-500 mt-2">Total: ${data.total} licen√ßa(s)</p>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå ${data.detail || 'Erro ao carregar'}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå Erro de conex√£o. Verifique se a API est√° rodando.</div>`;
            }
        }

        async function listarUsuarios() {
            const container = document.getElementById('userList');
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Carregando...</p>';
            
            try {
                const { response, data } = await apiCall('/api/admin/users?limit=1000');
                
                if (response.ok) {
                    if (data.users.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum usu√°rio cadastrado</p>';
                        return;
                    }
                    
                    let html = `
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-3 py-2 text-left">Email</th>
                                    <th class="px-3 py-2 text-left">Nome</th>
                                    <th class="px-3 py-2 text-center">Status</th>
                                    <th class="px-3 py-2 text-center">Email Verificado</th>
                                    <th class="px-3 py-2 text-center">Criado em</th>
                                    <th class="px-3 py-2 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.users.forEach((user, idx) => {
                        const statusClass = user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const verifiedClass = user.email_verified ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                        html += `
                            <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                <td class="px-3 py-2">${user.email}</td>
                                <td class="px-3 py-2">${user.name || '-'}</td>
                                <td class="px-3 py-2 text-center"><span class="px-2 py-1 rounded text-xs ${statusClass}">${user.is_active ? 'Ativo' : 'Inativo'}</span></td>
                                <td class="px-3 py-2 text-center"><span class="px-2 py-1 rounded text-xs ${verifiedClass}">${user.email_verified ? 'Sim' : 'N√£o'}</span></td>
                                <td class="px-3 py-2 text-center text-xs">${new Date(user.created_at).toLocaleDateString('pt-BR')}</td>
                                <td class="px-3 py-2 text-center">
                                    <button onclick="verDetalhesUsuario('${user.id}')" class="text-blue-600 hover:text-blue-800 text-xs">Ver</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    html += `<p class="text-sm text-gray-500 mt-2">Total: ${data.total} usu√°rio(s)</p>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå ${data.detail || 'Erro ao carregar'}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-800">‚ùå ${e.message || 'Erro de conex√£o'}</div>`;
            }
        }

        async function verDetalhesUsuario(userId) {
            try {
                const { response, data } = await apiCall(`/api/admin/users/${userId}`);
                
                if (response.ok) {
                    alert(`Detalhes do Usu√°rio:\n\nEmail: ${data.email}\nNome: ${data.name || '-'}\nAtivo: ${data.is_active ? 'Sim' : 'N√£o'}\nEmail Verificado: ${data.email_verified ? 'Sim' : 'N√£o'}\nCriado em: ${new Date(data.created_at).toLocaleString('pt-BR')}\nStripe Customer ID: ${data.stripe_customer_id || '-'}`);
                } else {
                    alert(`Erro: ${data.detail || 'N√£o foi poss√≠vel carregar os detalhes'}`);
                }
            } catch (e) {
                alert(`Erro: ${e.message}`);
            }
        }
    </script>
</body>
</html>

