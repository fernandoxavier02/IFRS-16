<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Engine IFRS 16</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/theme-neon.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            z-index: 10;
        }
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .header-brand img {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.4));
        }
        .header-brand h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-brand p {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .notification-icon {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--dark-card);
            border: 1px solid rgba(0, 212, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        .notification-icon:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
            transform: translateY(-2px);
        }
        .notification-icon svg {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        .notification-icon:hover svg {
            color: var(--neon-cyan);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 9px;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            animation: pulse-badge 2s infinite;
        }
        .notification-badge.hidden {
            display: none;
        }
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .value-card {
            background: linear-gradient(135deg, var(--dark-card) 0%, rgba(10, 22, 40, 0.9) 100%);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .value-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--card-accent);
        }
        .value-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 212, 255, 0.15);
        }
        .value-card.cyan { 
            --card-accent: linear-gradient(90deg, var(--neon-blue), var(--neon-cyan)); 
            border: 1px solid rgba(0, 212, 255, 0.2);
        }
        .value-card.purple { 
            --card-accent: linear-gradient(90deg, var(--neon-purple), var(--neon-magenta)); 
            border: 1px solid rgba(184, 41, 221, 0.2);
        }
        .value-card.amber { 
            --card-accent: linear-gradient(90deg, #f59e0b, #fbbf24); 
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        .value-card.emerald {
            --card-accent: linear-gradient(90deg, #10b981, #34d399);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        .value-card .label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .value-card .value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
        }
        .value-card.cyan .value { color: var(--neon-cyan); }
        .value-card.purple .value { color: var(--neon-purple); }
        .value-card.amber .value { color: #fbbf24; }
        .value-card.emerald .value { color: #34d399; }
        .value-card .sub {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 8px;
        }
        .table-dark {
            width: 100%;
            border-collapse: collapse;
            background: rgba(10, 14, 23, 0.6);
            border-radius: 8px;
            overflow: hidden;
        }
        .table-dark thead {
            background: rgba(0, 212, 255, 0.1);
        }
        .table-dark th {
            padding: 12px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .table-dark td {
            padding: 12px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .table-dark tbody tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        .license-key {
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.15em;
            font-size: 1.2rem;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        .license-box {
            background: rgba(10, 14, 23, 0.8);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .info-item .label {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        .info-item .value {
            color: var(--text-primary);
            font-weight: 500;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .badge-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .features-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .feature-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 212, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.1);
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .feature-item svg {
            flex-shrink: 0;
            color: var(--neon-cyan);
        }
        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .btn-danger {
            background: transparent;
            border: 1px solid rgba(255, 68, 102, 0.5);
            color: var(--error);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background: rgba(255, 68, 102, 0.1);
            border-color: var(--error);
        }
        .loading-spinner {
            text-align: center;
            padding: 80px 20px;
        }
        .loading-spinner .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--dark-border);
            border-top-color: var(--neon-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Circuit Background -->
    <div class="circuit-bg"></div>

    <div class="dashboard-container fade-in">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-brand">
                <img src="logo/Gemini_Generated_Image_rvkfr5rvkfr5rvkf.png" alt="FX Studio AI">
                <div>
                    <h1>Minha Conta</h1>
                    <p>Gerencie sua assinatura e licen√ßa</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="notifications.html" class="notification-icon" title="Notifica√ß√µes">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span id="notificationBadge" class="notification-badge hidden">0</span>
                </a>
                <button type="button" id="btnCalculator" onclick="accessCalculator()" class="btn-neon btn-neon-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 9h6v6H9z"/></svg>
                    Calculadora
                </button>
                <button type="button" onclick="logout()" class="btn-neon-outline btn-neon-sm">Sair</button>
            </div>
        </header>

        <!-- Loading -->
        <div id="loading" class="loading-spinner">
            <div class="spinner"></div>
            <p style="color: var(--text-secondary);">Carregando...</p>
        </div>

        <!-- Content -->
        <div id="content" style="display: none;">
            <!-- User Info -->
            <div class="glass-card" style="padding: 24px; margin-bottom: 24px;">
                <h2 class="section-title">Informa√ß√µes da Conta</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <p class="label">Nome</p>
                        <p id="userName" class="value">-</p>
                    </div>
                    <div class="info-item">
                        <p class="label">Email</p>
                        <p id="userEmail" class="value">-</p>
                    </div>
                </div>
            </div>

            <!-- Subscription Cards -->
            <div class="cards-grid">
                <div class="value-card cyan">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <p class="label">Status da Assinatura</p>
                        <span id="statusBadge" class="badge badge-success" style="display: none;">Ativa</span>
                    </div>
                    <p id="subStatus" class="value">-</p>
                    <p id="subPlan" class="sub">-</p>
                </div>
                <div class="value-card purple">
                    <p class="label">Pr√≥xima Renova√ß√£o</p>
                    <p id="subRenewal" class="value">-</p>
                    <p id="subCancelNote" class="sub" style="display: none; color: var(--warning);">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="display: inline-block; margin-right: 4px; vertical-align: middle;">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        Ser√° cancelada ao fim do per√≠odo
                    </p>
                </div>
                <div class="value-card amber">
                    <p class="label">Limites do Plano</p>
                    <p id="contractsLimit" class="value">0/0</p>
                    <p class="sub">Contratos utilizados</p>
                    <div id="usageBar" style="margin-top: 12px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 6px; overflow: hidden;">
                            <div id="usageProgress" style="background: linear-gradient(90deg, #f59e0b, #fbbf24); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscription Details Card (s√≥ aparece se tiver assinatura ativa) -->
            <div id="subscriptionDetails" class="glass-card" style="padding: 24px; margin-bottom: 24px; display: none;">
                <h2 class="section-title">Detalhes da Assinatura</h2>
                <div class="info-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="info-item">
                        <p class="label">Plano Atual</p>
                        <p id="planName" class="value">-</p>
                    </div>
                    <div class="info-item">
                        <p class="label">Per√≠odo Atual</p>
                        <p id="currentPeriod" class="value">-</p>
                    </div>
                    <div class="info-item">
                        <p class="label">ID da Assinatura</p>
                        <p id="stripeSubId" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-secondary);">-</p>
                    </div>
                    <div class="info-item">
                        <p class="label">Criada em</p>
                        <p id="createdAt" class="value">-</p>
                    </div>
                </div>

                <!-- Features do Plano -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">Recursos Inclu√≠dos</h3>
                    <div id="planFeatures" class="features-list"></div>
                </div>
            </div>

            <!-- License Card -->
            <div class="glass-card" style="padding: 24px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h2 class="section-title" style="margin-bottom: 0;">Sua Chave de Licen√ßa</h2>
                    <button onclick="copyLicenseKey()" id="copyBtn" class="btn-neon-outline btn-neon-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        Copiar
                    </button>
                </div>
                
                <div id="licenseArea" class="license-box">
                    <p id="licenseKey" class="license-key">-</p>
                    <p id="licenseType" style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">-</p>
                    <p id="licenseExpires" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px;">-</p>
                </div>

                <div id="noLicense" style="display: none; text-align: center; padding: 40px 20px;">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Voc√™ ainda n√£o tem uma licen√ßa ativa.</p>
                    <a href="landing.html#pricing" class="btn-neon">Ver Planos</a>
                </div>
            </div>

            <!-- Dashboard Anal√≠tico -->
            <div id="analyticsDashboard" class="glass-card" style="padding: 24px; margin-bottom: 24px; display: block !important;">
                <h2 class="section-title">üìä Dashboard Anal√≠tico</h2>
                
                <!-- M√©tricas Principais -->
                <div class="cards-grid" style="margin-bottom: 32px;">
                    <div class="value-card cyan">
                        <p class="label">Total de Contratos</p>
                        <p id="metricTotalContracts" class="value">-</p>
                    </div>
                    <div class="value-card purple">
                        <p class="label">Valor Total de Passivos</p>
                        <p id="metricTotalPassivos" class="value">-</p>
                    </div>
                    <div class="value-card amber">
                        <p class="label">Valor Total de Ativos</p>
                        <p id="metricTotalAtivos" class="value">-</p>
                    </div>
                    <div class="value-card emerald">
                        <p class="label">Despesas Mensais Totais</p>
                        <p id="metricDespesasMensais" class="value">-</p>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 24px;">
                    <!-- Evolu√ß√£o Temporal -->
                    <div class="glass-card-light" style="padding: 20px;">
                        <h3 style="color: var(--text-primary); font-size: 1rem; margin-bottom: 16px;">üìà Evolu√ß√£o do Passivo</h3>
                        <canvas id="evolutionChart" style="max-height: 300px;"></canvas>
                    </div>

                    <!-- Distribui√ß√£o por Categoria -->
                    <div class="glass-card-light" style="padding: 20px;">
                        <h3 style="color: var(--text-primary); font-size: 1rem; margin-bottom: 16px;">ü•ß Distribui√ß√£o por Categoria</h3>
                        <canvas id="distributionChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Despesas Mensais -->
                <div class="glass-card-light" style="padding: 20px; margin-bottom: 24px;">
                    <h3 style="color: var(--text-primary); font-size: 1rem; margin-bottom: 16px;">üìä Despesas Mensais por Contrato</h3>
                    <canvas id="expensesChart" style="max-height: 300px;"></canvas>
                </div>

                <!-- Pr√≥ximos Vencimentos -->
                <div class="glass-card-light" style="padding: 20px;">
                    <h3 style="color: var(--text-primary); font-size: 1rem; margin-bottom: 16px;">‚ö†Ô∏è Pr√≥ximos Vencimentos</h3>
                    <div id="expirationsTable" style="overflow-x: auto;">
                        <table class="table-dark" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Contrato</th>
                                    <th style="text-align: center;">Vencimento</th>
                                    <th style="text-align: center;">Dias Restantes</th>
                                    <th style="text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="expirationsTableBody">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="glass-card" style="padding: 24px;">
                <h2 class="section-title">Gerenciar Assinatura</h2>
                <div class="actions-row">
                    <button onclick="openPortal()" id="portalBtn" class="btn-neon-outline btn-neon-sm" style="display: none;">
                        Gerenciar Pagamento
                    </button>
                    <button onclick="subscribeToPlan()" id="upgradeBtn" class="btn-neon btn-neon-sm" style="display: none;">
                        Assinar Plano
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const getApiUrl = () => {
            const hostname = window.location.hostname;

            if (
                hostname.includes('fxstudioai.com') ||
                hostname.includes('web.app') ||
                hostname.includes('firebaseapp.com')
            ) {
                return 'https://ifrs16-backend-ox4zylcs5a-rj.a.run.app';
            }

            return 'http://localhost:8000';
        };

        const API_URL = getApiUrl();
        let dashboardData = null;

        // Formatar nome do plano
        function formatPlanName(planType) {
            const names = {
                'basic_monthly': 'B√°sico Mensal',
                'basic_yearly': 'B√°sico Anual',
                'pro_monthly': 'Pro Mensal',
                'pro_yearly': 'Pro Anual',
                'enterprise_monthly': 'Enterprise Mensal',
                'enterprise_yearly': 'Enterprise Anual'
            };
            return names[planType] || planType;
        }

        // Obter limites do plano
        function getPlanLimits(planType) {
            const limits = {
                'basic_monthly': { max_contracts: 5, features: ['Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Email'] },
                'basic_yearly': { max_contracts: 5, features: ['Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Email'] },
                'pro_monthly': { max_contracts: 20, features: ['Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Priorit√°rio', 'API Access'] },
                'pro_yearly': { max_contracts: 20, features: ['Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Priorit√°rio', 'API Access'] },
                'enterprise_monthly': { max_contracts: -1, features: ['Contratos Ilimitados', 'Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Dedicado', 'API Access', 'Treinamento', 'SLA'] },
                'enterprise_yearly': { max_contracts: -1, features: ['Contratos Ilimitados', 'Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Dedicado', 'API Access', 'Treinamento', 'SLA'] }
            };
            return limits[planType] || { max_contracts: 0, features: [] };
        }

        // Renderizar features do plano
        function renderPlanFeatures(planLimits) {
            const container = document.getElementById('planFeatures');
            container.innerHTML = '';

            planLimits.features.forEach(feature => {
                const featureEl = document.createElement('div');
                featureEl.className = 'feature-item';
                featureEl.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    <span>${feature}</span>
                `;
                container.appendChild(featureEl);
            });
        }

        async function loadNotificationCount() {
            const token = localStorage.getItem('ifrs16_auth_token');
            if (!token) return;

            try {
                const response = await fetch(`${API_URL}/api/notifications/count`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('notificationBadge');
                    if (data.unread_count > 0) {
                        badge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.warn('Erro ao carregar notifica√ß√µes:', error);
            }
        }

        // Flag para evitar loops de redirecionamento
        let isRedirecting = false;

        async function loadDashboard() {
            console.log('üöÄ Iniciando loadDashboard()...');

            // Evitar chamadas m√∫ltiplas
            if (isRedirecting) {
                console.log('‚ö†Ô∏è J√° est√° redirecionando, ignorando...');
                return;
            }

            const token = localStorage.getItem('ifrs16_auth_token');

            if (!token) {
                console.log('‚ùå Token n√£o encontrado, redirecionando para login...');
                isRedirecting = true;
                window.location.replace('login.html');
                return;
            }

            // Verificar se h√° par√¢metro validate_license na URL (vindo do email)
            const urlParams = new URLSearchParams(window.location.search);
            const licenseToValidate = urlParams.get('validate_license');

            // Armazenar licen√ßa para validar depois e limpar URL imediatamente
            let pendingLicenseValidation = null;

            if (licenseToValidate) {
                console.log('üìã Licen√ßa detectada na URL para valida√ß√£o:', licenseToValidate);
                pendingLicenseValidation = licenseToValidate;

                // Limpar par√¢metro da URL IMEDIATAMENTE para evitar loops
                window.history.replaceState({}, document.title, window.location.pathname);

                // Mostrar mensagem de carregamento
                const loadingEl = safeGetElement('loading');
                if (loadingEl) {
                    loadingEl.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner" style="width: 48px; height: 48px; margin: 0 auto 20px;"></div>
                            <p style="color: var(--text-primary); font-size: 1.1rem; margin-bottom: 8px;">Validando sua licen√ßa...</p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Aguarde enquanto processamos sua licen√ßa.</p>
                        </div>
                    `;
                }
            }

            // Carregar contador de notifica√ß√µes em paralelo
            loadNotificationCount();

            try {
                // Carregar perfil do usu√°rio
                const profileResponse = await fetch(`${API_URL}/api/user/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (profileResponse.status === 401) {
                    localStorage.removeItem('ifrs16_auth_token');
                    window.location.href = 'login.html';
                    return;
                }

                const profile = await profileResponse.json();

                // Carregar assinatura
                const subscriptionResponse = await fetch(`${API_URL}/api/user/subscription`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let subscription = null;
                if (subscriptionResponse.ok) {
                    subscription = await subscriptionResponse.json();
                    console.log('üìä Dados da assinatura recebidos:', subscription);
                } else {
                    console.warn('‚ö†Ô∏è Erro ao buscar assinatura:', subscriptionResponse.status);
                }

                // A API agora retorna contracts_count dentro de subscription
                const contractsCount = subscription?.contracts_count || 0;

                dashboardData = {
                    user: profile,
                    subscription: subscription,
                    license: subscription?.license || null,
                    stats: {
                        total_validations: 0,
                        contracts_count: contractsCount
                    }
                };

                console.log('üìã Dashboard data final:', dashboardData);
                if (!dashboardData) {
                    console.error('‚ùå dashboardData √© null ou undefined!');
                    document.getElementById('loading').innerHTML = '<p style="color: var(--error);">Erro: Dados do dashboard n√£o carregados.</p>';
                    return;
                }

                // Se h√° licen√ßa para validar, validar ANTES de renderizar dashboard
                // Isso mant√©m a tela de "Validando licen√ßa..." vis√≠vel
                if (pendingLicenseValidation) {
                    console.log('‚úÖ Dados carregados, iniciando valida√ß√£o autom√°tica da licen√ßa...');
                    // Validar diretamente - isso vai redirecionar para calculadora se bem-sucedido
                    await validateLicenseDirectly();
                    // Se chegou aqui, a valida√ß√£o falhou (n√£o redirecionou)
                    // Renderizar dashboard para mostrar erro ou permitir a√ß√£o manual
                    renderDashboard();
                } else {
                    // Fluxo normal sem licen√ßa pendente
                    renderDashboard();
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: var(--error);">Erro ao carregar dados. <button onclick="loadDashboard()" class="btn-neon-outline btn-neon-sm">Tentar novamente</button></p>
                `;
            }
        }

        // Helper function para acessar elementos com seguran√ßa
        function safeGetElement(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn(`‚ö†Ô∏è Elemento #${id} n√£o encontrado`);
            }
            return el;
        }

        function renderDashboard() {
            const loadingEl = safeGetElement('loading');
            if (loadingEl) loadingEl.style.display = 'none';
            
            const contentDiv = safeGetElement('content');
            if (contentDiv) {
                contentDiv.style.display = 'block';
                console.log('‚úÖ Conte√∫do do dashboard exibido');
                
                // Verificar se analyticsDashboard existe dentro de content
                const analyticsSection = contentDiv.querySelector('#analyticsDashboard');
                if (analyticsSection) {
                    console.log('‚úÖ Se√ß√£o analyticsDashboard encontrada dentro de #content');
                    analyticsSection.style.display = 'block';
                } else {
                    console.warn('‚ö†Ô∏è analyticsDashboard n√£o encontrado dentro de #content');
                    // Tentar encontrar por texto
                    const allDivs = contentDiv.querySelectorAll('div');
                    allDivs.forEach((div, index) => {
                        if (div.textContent.includes('Dashboard Anal√≠tico')) {
                            console.log(`‚úÖ Encontrado Dashboard Anal√≠tico no div ${index}`);
                            div.id = 'analyticsDashboard';
                            div.style.display = 'block';
                        }
                    });
                }
            } else {
                console.error('‚ùå Elemento #content n√£o encontrado!');
                return; // N√£o continuar se o conte√∫do n√£o existir
            }

            // User info
            const userNameEl = safeGetElement('userName');
            const userEmailEl = safeGetElement('userEmail');
            if (userNameEl) userNameEl.textContent = dashboardData.user.name;
            if (userEmailEl) userEmailEl.textContent = dashboardData.user.email;

            // Adicionar empresa se existir
            if (dashboardData.user.company_name) {
                const emailItem = document.querySelector('#userEmail').parentElement;
                const companyItem = document.createElement('div');
                companyItem.className = 'info-item';
                companyItem.innerHTML = `
                    <p class="label">Empresa</p>
                    <p class="value">${dashboardData.user.company_name}</p>
                `;
                emailItem.parentElement.appendChild(companyItem);
            }

            // Stats
            // TODO: Adicionar elemento totalValidations no HTML se necess√°rio
            // document.getElementById('totalValidations').textContent = dashboardData.stats.total_validations;

            // Subscription
            console.log('üîç Verificando assinatura:', {
                hasSubscription: !!dashboardData.subscription,
                status: dashboardData.subscription?.status,
                plan_type: dashboardData.subscription?.plan_type
            });

            if (dashboardData.subscription && dashboardData.subscription.status === 'active') {
                const sub = dashboardData.subscription;
                console.log('‚úÖ Assinatura ativa detectada, renderizando dados...');

                // Status Badge
                const badge = safeGetElement('statusBadge');
                if (badge) {
                    badge.style.display = 'inline-block';
                    badge.className = 'badge badge-success';
                    badge.textContent = 'Ativa';
                }

                const subStatusEl = safeGetElement('subStatus');
                const subPlanEl = safeGetElement('subPlan');
                if (subStatusEl) subStatusEl.textContent = 'Ativa';
                if (subPlanEl) subPlanEl.textContent = formatPlanName(sub.plan_type);

                // Renova√ß√£o
                const subRenewalEl = safeGetElement('subRenewal');
                if (sub.current_period_end && subRenewalEl) {
                    const endDate = new Date(sub.current_period_end);
                    subRenewalEl.textContent = endDate.toLocaleDateString('pt-BR');

                    // Aviso se cancelar ao fim do per√≠odo
                    if (sub.cancel_at_period_end) {
                        const cancelNoteEl = safeGetElement('subCancelNote');
                        if (cancelNoteEl) cancelNoteEl.style.display = 'block';
                    }
                } else if (subRenewalEl) {
                    subRenewalEl.textContent = 'Vital√≠cio';
                }

                // Limites do plano
                const planLimits = getPlanLimits(sub.plan_type);
                const contractsUsed = dashboardData.stats.contracts_count || 0;
                const contractsLimitEl = safeGetElement('contractsLimit');
                if (contractsLimitEl) {
                    contractsLimitEl.textContent = `${contractsUsed}/${planLimits.max_contracts === -1 ? '‚àû' : planLimits.max_contracts}`;
                }

                // Barra de progresso
                if (planLimits.max_contracts > 0) {
                    const usagePercent = (contractsUsed / planLimits.max_contracts) * 100;
                    const usageBarEl = safeGetElement('usageBar');
                    const usageProgressEl = safeGetElement('usageProgress');
                    if (usageBarEl) usageBarEl.style.display = 'block';
                    if (usageProgressEl) {
                        usageProgressEl.style.width = `${Math.min(usagePercent, 100)}%`;

                        // Mudar cor se pr√≥ximo do limite
                        if (usagePercent >= 90) {
                            usageProgressEl.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                        } else if (usagePercent >= 70) {
                            usageProgressEl.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                        }
                    }
                }

                // Detalhes da assinatura
                const subscriptionDetailsEl = safeGetElement('subscriptionDetails');
                const planNameEl = safeGetElement('planName');
                if (subscriptionDetailsEl) subscriptionDetailsEl.style.display = 'block';
                if (planNameEl) planNameEl.textContent = formatPlanName(sub.plan_type);

                if (sub.current_period_start && sub.current_period_end) {
                    const start = new Date(sub.current_period_start).toLocaleDateString('pt-BR');
                    const end = new Date(sub.current_period_end).toLocaleDateString('pt-BR');
                    const currentPeriodEl = safeGetElement('currentPeriod');
                    if (currentPeriodEl) currentPeriodEl.textContent = `${start} - ${end}`;
                }

                const stripeSubIdEl = safeGetElement('stripeSubId');
                if (stripeSubIdEl) stripeSubIdEl.textContent = sub.stripe_subscription_id || '-';

                if (sub.created_at) {
                    const createdAtEl = safeGetElement('createdAt');
                    if (createdAtEl) createdAtEl.textContent = new Date(sub.created_at).toLocaleDateString('pt-BR');
                }

                // Features do plano
                renderPlanFeatures(planLimits);

                const portalBtnEl = safeGetElement('portalBtn');
                if (portalBtnEl) portalBtnEl.style.display = 'inline-flex';
            } else {
                // Sem assinatura ativa
                const badge = safeGetElement('statusBadge');
                if (badge) {
                    badge.style.display = 'inline-block';
                    badge.className = 'badge badge-error';
                    badge.textContent = 'Inativa';
                }

                const subStatusEl = safeGetElement('subStatus');
                const subPlanEl = safeGetElement('subPlan');
                const subRenewalEl = safeGetElement('subRenewal');
                const contractsLimitEl = safeGetElement('contractsLimit');
                const upgradeBtnEl = safeGetElement('upgradeBtn');
                const portalBtnEl = safeGetElement('portalBtn');
                const subscriptionDetailsEl = safeGetElement('subscriptionDetails');
                
                if (subStatusEl) subStatusEl.textContent = 'Inativa';
                if (subPlanEl) subPlanEl.textContent = 'Sem assinatura';
                if (subRenewalEl) subRenewalEl.textContent = '-';
                if (contractsLimitEl) contractsLimitEl.textContent = '0/0';
                if (upgradeBtnEl) upgradeBtnEl.style.display = 'inline-flex';
                if (portalBtnEl) portalBtnEl.style.display = 'none';
                if (subscriptionDetailsEl) subscriptionDetailsEl.style.display = 'none';
            }

            // License
            if (dashboardData.license) {
                const lic = dashboardData.license;
                const licenseKeyEl = safeGetElement('licenseKey');
                const licenseTypeEl = safeGetElement('licenseType');
                const licenseExpiresEl = safeGetElement('licenseExpires');
                const licenseAreaEl = safeGetElement('licenseArea');
                const noLicenseEl = safeGetElement('noLicense');
                
                if (licenseKeyEl) licenseKeyEl.textContent = lic.key;
                if (licenseTypeEl) licenseTypeEl.textContent = `Licen√ßa ${lic.type.toUpperCase()}`;
                
                if (lic.expires_at && licenseExpiresEl) {
                    const expDate = new Date(lic.expires_at);
                    licenseExpiresEl.textContent = `V√°lida at√© ${expDate.toLocaleDateString('pt-BR')}`;
                } else if (licenseExpiresEl) {
                    licenseExpiresEl.textContent = 'Licen√ßa vital√≠cia';
                }

                if (licenseAreaEl) licenseAreaEl.style.display = 'block';
                if (noLicenseEl) noLicenseEl.style.display = 'none';
            } else {
                const licenseAreaEl = safeGetElement('licenseArea');
                const noLicenseEl = safeGetElement('noLicense');
                if (licenseAreaEl) licenseAreaEl.style.display = 'none';
                if (noLicenseEl) noLicenseEl.style.display = 'block';
            }

            // Garantir que a se√ß√£o do dashboard anal√≠tico est√° vis√≠vel
            // Aguardar um pouco para garantir que o DOM est√° pronto
            setTimeout(() => {
                const analyticsSection = document.getElementById('analyticsDashboard');
                if (analyticsSection) {
                    analyticsSection.style.display = 'block';
                    console.log('‚úÖ Se√ß√£o analyticsDashboard garantida como vis√≠vel');
                }
            }, 200);

            // Carregar dashboard anal√≠tico ap√≥s renderizar dashboard principal
            setTimeout(() => {
                console.log('Iniciando carregamento do dashboard anal√≠tico...');
                loadAnalyticsDashboard();
            }, 500);
        }

        function copyLicenseKey() {
            const key = document.getElementById('licenseKey').textContent;
            navigator.clipboard.writeText(key).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Copiado!';
                setTimeout(() => {
                    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> Copiar';
                }, 2000);
            });
        }

        async function openPortal() {
            const token = localStorage.getItem('ifrs16_auth_token');

            try {
                // ‚úì ATUALIZADO: usar /api/payments/portal ao inv√©s de /api/stripe/create-portal-session
                const response = await fetch(`${API_URL}/api/payments/portal`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    window.location.href = data.portal_url;  // ‚úì ATUALIZADO: portal_url ao inv√©s de url
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Erro ao abrir portal de pagamento');
                }
            } catch (error) {
                alert('Erro de conex√£o');
            }
        }

        async function subscribeToPlan() {
            // Redirecionar para p√°gina de pre√ßos
            window.location.href = 'landing.html#pricing';
        }

        function logout() {
            localStorage.removeItem('ifrs16_auth_token');
            localStorage.removeItem('ifrs16_user_type');
            window.location.href = 'login.html';
        }

        // Validar licen√ßa diretamente (usado quando vem do link do email)
        async function validateLicenseDirectly() {
            const authToken = localStorage.getItem('ifrs16_auth_token');
            
            if (!authToken) {
                console.error('‚ùå Token de autentica√ß√£o n√£o encontrado');
                showAccessDeniedModal('sem_assinatura');
                return;
            }

            console.log('üîç Validando licen√ßa diretamente...');
            console.log('   API URL:', API_URL);
            console.log('   Token presente:', !!authToken);

            try {
                const response = await fetch(`${API_URL}/api/auth/me/validate-license-token`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì• Resposta recebida:', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });

                if (!response.ok) {
                    let errorDetail = 'Erro desconhecido';
                    try {
                        const error = await response.json();
                        errorDetail = error.detail || error.message || JSON.stringify(error);
                        console.error('‚ùå Erro detalhado:', error);
                    } catch (e) {
                        const text = await response.text();
                        errorDetail = text || `Status ${response.status}`;
                        console.error('‚ùå Erro (texto):', text);
                    }
                    
                    console.error('‚ùå Falha na valida√ß√£o:', {
                        status: response.status,
                        detail: errorDetail
                    });
                    
                    showAccessDeniedModal('erro_validacao');
                    
                    // Atualizar mensagem do modal com detalhes do erro
                    const modalMessage = document.getElementById('modalMessage');
                    if (modalMessage) {
                        modalMessage.textContent = `N√£o foi poss√≠vel validar sua licen√ßa: ${errorDetail}. Por favor, tente novamente ou entre em contato com o suporte se o problema persistir.`;
                    }
                    
                    return;
                }

                const licenseData = await response.json();
                console.log('‚úÖ Dados da licen√ßa recebidos:', licenseData);

                // Salvar dados da licen√ßa no localStorage
                localStorage.setItem('ifrs16_license', licenseData.key);
                localStorage.setItem('ifrs16_customer_name', licenseData.customer_name);
                localStorage.setItem('ifrs16_token', licenseData.token);
                localStorage.setItem('ifrs16_user_token', authToken);

                console.log('‚úÖ Licen√ßa validada e salva. Redirecionando para calculadora...');

                // Redirecionar para calculadora (usando replace para n√£o permitir voltar)
                isRedirecting = true;
                window.location.replace('Calculadora_IFRS16_Deploy.html');

            } catch (error) {
                console.error('‚ùå Erro ao validar licen√ßa:', error);
                console.error('   Tipo:', error.constructor.name);
                console.error('   Mensagem:', error.message);
                console.error('   Stack:', error.stack);
                
                showAccessDeniedModal('erro_conexao');
                
                // Atualizar mensagem do modal com detalhes do erro
                const modalMessage = document.getElementById('modalMessage');
                if (modalMessage) {
                    modalMessage.textContent = `Erro de conex√£o ao validar licen√ßa: ${error.message}. Verifique sua conex√£o com a internet e tente novamente.`;
                }
            }
        }

        // Verificar acesso √† calculadora
        async function accessCalculator() {
            // Verificar se tem assinatura ativa
            if (!dashboardData.subscription) {
                showAccessDeniedModal('sem_assinatura');
                return;
            }

            // Verificar se tem licen√ßa
            if (!dashboardData.license) {
                showAccessDeniedModal('sem_licenca');
                return;
            }

            // Verificar se a licen√ßa est√° ativa
            if (dashboardData.license.status !== 'active') {
                showAccessDeniedModal('licenca_inativa');
                return;
            }

            // Verificar se a assinatura est√° ativa
            if (dashboardData.subscription.status !== 'active') {
                showAccessDeniedModal('assinatura_inativa');
                return;
            }

            // IMPORTANTE: Validar a licen√ßa pelo token do usu√°rio e salvar os dados
            // Isso garante que a licen√ßa √© exclusiva do usu√°rio e vinculada a ele
            const authToken = localStorage.getItem('ifrs16_auth_token');

            try {
                console.log('üîç Iniciando valida√ß√£o de licen√ßa...');
                console.log('   API URL:', API_URL);
                console.log('   Token presente:', !!authToken);
                
                const response = await fetch(`${API_URL}/api/auth/me/validate-license-token`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì• Resposta recebida:', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });

                if (!response.ok) {
                    let errorDetail = 'Erro desconhecido';
                    try {
                        const error = await response.json();
                        errorDetail = error.detail || error.message || JSON.stringify(error);
                        console.error('‚ùå Erro detalhado:', error);
                    } catch (e) {
                        const text = await response.text();
                        errorDetail = text || `Status ${response.status}`;
                        console.error('‚ùå Erro (texto):', text);
                    }
                    
                    // Mostrar erro espec√≠fico no console
                    console.error('‚ùå Falha na valida√ß√£o:', {
                        status: response.status,
                        detail: errorDetail
                    });
                    
                    showAccessDeniedModal('erro_validacao');
                    
                    // Atualizar mensagem do modal com detalhes do erro
                    const modalMessage = document.getElementById('modalMessage');
                    if (modalMessage) {
                        modalMessage.textContent = `N√£o foi poss√≠vel validar sua licen√ßa: ${errorDetail}. Por favor, tente novamente ou entre em contato com o suporte se o problema persistir.`;
                    }
                    
                    return;
                }

                const licenseData = await response.json();

                // Salvar dados da licen√ßa no localStorage
                // A licen√ßa √© exclusiva do usu√°rio e s√≥ muda quando o plano muda
                localStorage.setItem('ifrs16_license', licenseData.key);
                localStorage.setItem('ifrs16_customer_name', licenseData.customer_name);
                localStorage.setItem('ifrs16_token', licenseData.token); // Token JWT da licen√ßa
                localStorage.setItem('ifrs16_user_token', authToken); // Token do usu√°rio

                console.log('‚úÖ Licen√ßa validada e salva. Acesso liberado √† calculadora.');

                // Tudo OK, redirecionar para calculadora (usando replace para n√£o permitir voltar)
                isRedirecting = true;
                window.location.replace('Calculadora_IFRS16_Deploy.html');

            } catch (error) {
                console.error('‚ùå Erro ao acessar calculadora:', error);
                console.error('   Tipo:', error.constructor.name);
                console.error('   Mensagem:', error.message);
                console.error('   Stack:', error.stack);
                
                showAccessDeniedModal('erro_conexao');
                
                // Atualizar mensagem do modal com detalhes do erro
                const modalMessage = document.getElementById('modalMessage');
                if (modalMessage) {
                    modalMessage.textContent = `Erro de conex√£o ao validar licen√ßa: ${error.message}. Verifique sua conex√£o com a internet e tente novamente.`;
                }
            }
        }

        // Mostrar modal de acesso negado
        function showAccessDeniedModal(reason) {
            const modal = safeGetElement('accessDeniedModal');
            const title = safeGetElement('modalTitle');
            const message = safeGetElement('modalMessage');
            const actionBtn = safeGetElement('modalActionBtn');
            
            if (!modal || !title || !message || !actionBtn) {
                console.error('‚ùå Elementos do modal n√£o encontrados');
                return;
            }

            let titleText = '';
            let messageText = '';
            let buttonText = 'Ver Planos e Assinar';
            let buttonAction = () => window.location.href = 'landing.html#pricing';

            switch(reason) {
                case 'sem_assinatura':
                    titleText = 'Assinatura Necess√°ria';
                    messageText = 'Para acessar a calculadora IFRS 16, voc√™ precisa ter uma assinatura ativa. Escolha o plano ideal para suas necessidades e comece a usar agora!';
                    break;
                case 'sem_licenca':
                    titleText = 'Licen√ßa N√£o Encontrada';
                    messageText = 'Sua assinatura est√° ativa, mas a licen√ßa ainda n√£o foi gerada. Por favor, entre em contato com o suporte ou tente novamente em alguns minutos.';
                    buttonText = 'Entrar em Contato';
                    buttonAction = () => window.location.href = 'mailto:contato@fxstudioai.com';
                    break;
                case 'licenca_inativa':
                    titleText = 'Licen√ßa Inativa';
                    messageText = 'Sua licen√ßa n√£o est√° ativa. Isso pode acontecer se sua assinatura expirou ou foi cancelada. Renove sua assinatura para continuar usando a calculadora.';
                    break;
                case 'assinatura_inativa':
                    titleText = 'Assinatura Inativa';
                    messageText = 'Sua assinatura n√£o est√° ativa. Por favor, renove sua assinatura para ter acesso √† calculadora IFRS 16.';
                    break;
                case 'erro_validacao':
                    titleText = 'Erro na Valida√ß√£o da Licen√ßa';
                    messageText = 'N√£o foi poss√≠vel validar sua licen√ßa. Por favor, tente novamente ou entre em contato com o suporte se o problema persistir.';
                    buttonText = 'Entrar em Contato';
                    buttonAction = () => window.location.href = 'mailto:contato@fxstudioai.com';
                    break;
                case 'erro_conexao':
                    titleText = 'Erro de Conex√£o';
                    messageText = 'N√£o foi poss√≠vel conectar ao servidor. Verifique sua conex√£o com a internet e tente novamente.';
                    buttonText = 'Tentar Novamente';
                    buttonAction = () => window.location.reload();
                    break;
            }

            if (title) title.textContent = titleText;
            if (message) message.textContent = messageText;
            if (actionBtn) {
                actionBtn.textContent = buttonText;
                actionBtn.onclick = buttonAction;
            }
            if (modal) modal.style.display = 'flex';
        }

        // Fechar modal
        function closeAccessDeniedModal() {
            const modal = safeGetElement('accessDeniedModal');
            if (modal) modal.style.display = 'none';
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = safeGetElement('accessDeniedModal');
            if (modal && event.target === modal) {
                closeAccessDeniedModal();
            }
        }

        // Inicializar
        // ============================================================
        // DASHBOARD ANAL√çTICO
        // ============================================================

        let evolutionChart = null;
        let distributionChart = null;
        let expensesChart = null;

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        async function loadAnalyticsDashboard() {
            const token = localStorage.getItem('ifrs16_auth_token');
            if (!token) {
                console.warn('‚ö†Ô∏è Token n√£o encontrado, dashboard anal√≠tico n√£o ser√° carregado');
                return;
            }

            console.log('üìä Carregando dashboard anal√≠tico...', { API_URL, hasToken: !!token });

            try {
                // Carregar m√©tricas gerais
                const metricsUrl = `${API_URL}/api/user/dashboard/metrics`;
                console.log('üîó Chamando API:', metricsUrl);
                
                const metricsResponse = await fetch(metricsUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('üì• Resposta recebida:', metricsResponse.status, metricsResponse.statusText);
                
                if (!metricsResponse.ok) {
                    console.error('‚ùå Erro ao carregar m√©tricas:', metricsResponse.status, metricsResponse.statusText);
                    const errorText = await metricsResponse.text();
                    console.error('üìÑ Resposta de erro:', errorText);
                    
                    // Mostrar erro na p√°gina
                    const dashboardSection = document.getElementById('analyticsDashboard');
                    if (dashboardSection) {
                        const errorDiv = document.createElement('div');
                        errorDiv.style.cssText = 'padding: 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: var(--text-primary); margin: 20px 0;';
                        errorDiv.innerHTML = `<strong>Erro ao carregar m√©tricas:</strong> ${metricsResponse.status} - ${metricsResponse.statusText}`;
                        dashboardSection.insertBefore(errorDiv, dashboardSection.firstChild);
                    }
                } else {
                    const metrics = await metricsResponse.json();
                    console.log('‚úÖ M√©tricas carregadas:', metrics);
                    
                    const metricTotalContractsEl = safeGetElement('metricTotalContracts');
                    const metricTotalPassivosEl = safeGetElement('metricTotalPassivos');
                    const metricTotalAtivosEl = safeGetElement('metricTotalAtivos');
                    const metricDespesasMensaisEl = safeGetElement('metricDespesasMensais');
                    
                    console.log('üîç Elementos encontrados:', {
                        totalContracts: !!metricTotalContractsEl,
                        totalPassivos: !!metricTotalPassivosEl,
                        totalAtivos: !!metricTotalAtivosEl,
                        despesasMensais: !!metricDespesasMensaisEl
                    });
                    
                    if (metricTotalContractsEl) {
                        metricTotalContractsEl.textContent = metrics.total_contracts || 0;
                        console.log('‚úÖ Total de contratos atualizado:', metrics.total_contracts || 0);
                    } else {
                        console.warn('‚ö†Ô∏è Elemento metricTotalContracts n√£o encontrado');
                    }
                    
                    if (metricTotalPassivosEl) {
                        metricTotalPassivosEl.textContent = formatCurrency(metrics.total_passivos || 0);
                        console.log('‚úÖ Total de passivos atualizado:', metrics.total_passivos || 0);
                    } else {
                        console.warn('‚ö†Ô∏è Elemento metricTotalPassivos n√£o encontrado');
                    }
                    
                    if (metricTotalAtivosEl) {
                        metricTotalAtivosEl.textContent = formatCurrency(metrics.total_ativos || 0);
                        console.log('‚úÖ Total de ativos atualizado:', metrics.total_ativos || 0);
                    } else {
                        console.warn('‚ö†Ô∏è Elemento metricTotalAtivos n√£o encontrado');
                    }
                    
                    if (metricDespesasMensaisEl) {
                        metricDespesasMensaisEl.textContent = formatCurrency(metrics.total_despesas_mensais || 0);
                        console.log('‚úÖ Despesas mensais atualizadas:', metrics.total_despesas_mensais || 0);
                    } else {
                        console.warn('‚ö†Ô∏è Elemento metricDespesasMensais n√£o encontrado');
                    }
                }

                // Carregar evolu√ß√£o temporal
                const evolutionResponse = await fetch(`${API_URL}/api/user/dashboard/evolution?months=12`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (evolutionResponse.ok) {
                    const evolution = await evolutionResponse.json();
                    console.log('‚úÖ Evolu√ß√£o carregada:', evolution);
                    renderEvolutionChart(evolution.evolution);
                } else {
                    console.warn('‚ö†Ô∏è Erro ao carregar evolu√ß√£o:', evolutionResponse.status);
                }

                // Carregar distribui√ß√£o
                const distributionResponse = await fetch(`${API_URL}/api/user/dashboard/distribution`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (distributionResponse.ok) {
                    const distribution = await distributionResponse.json();
                    console.log('‚úÖ Distribui√ß√£o carregada:', distribution);
                    renderDistributionChart(distribution.distribution);
                } else {
                    console.warn('‚ö†Ô∏è Erro ao carregar distribui√ß√£o:', distributionResponse.status);
                }

                // Carregar despesas mensais
                const expensesResponse = await fetch(`${API_URL}/api/user/dashboard/monthly-expenses`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (expensesResponse.ok) {
                    const expenses = await expensesResponse.json();
                    console.log('‚úÖ Despesas mensais carregadas:', expenses);
                    renderExpensesChart(expenses.monthly_expenses);
                } else {
                    console.warn('‚ö†Ô∏è Erro ao carregar despesas mensais:', expensesResponse.status);
                }

                // Carregar pr√≥ximos vencimentos
                const expirationsResponse = await fetch(`${API_URL}/api/user/dashboard/upcoming-expirations?days=90`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (expirationsResponse.ok) {
                    const expirations = await expirationsResponse.json();
                    console.log('‚úÖ Pr√≥ximos vencimentos carregados:', expirations);
                    renderExpirationsTable(expirations.upcoming_expirations);
                } else {
                    console.warn('‚ö†Ô∏è Erro ao carregar pr√≥ximos vencimentos:', expirationsResponse.status);
                }
                
                console.log('‚úÖ Dashboard anal√≠tico carregado com sucesso!');
            } catch (error) {
                console.error('Erro ao carregar dashboard anal√≠tico:', error);
                // Mostrar mensagem de erro no dashboard
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'padding: 20px; background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); border-radius: 8px; color: var(--text-primary); margin: 20px 0;';
                errorMsg.textContent = `Erro ao carregar dashboard: ${error.message}`;
                const dashboardSection = document.querySelector('.glass-card:has(#metricTotalContracts)');
                if (dashboardSection) {
                    dashboardSection.appendChild(errorMsg);
                }
            }
        }

        function renderEvolutionChart(data) {
            const ctx = document.getElementById('evolutionChart');
            if (!ctx) return;

            if (evolutionChart) {
                evolutionChart.destroy();
            }

            const labels = data.map(d => {
                const [year, month] = d.month.split('-');
                const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                return `${monthNames[parseInt(month) - 1]}/${year.slice(2)}`;
            });
            const values = data.map(d => d.passivo);

            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Passivo Total (R$)',
                        data: values,
                        borderColor: 'rgb(0, 212, 255)',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(255, 255, 255, 0.8)' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function renderDistributionChart(data) {
            const ctx = document.getElementById('distributionChart');
            if (!ctx) return;

            if (distributionChart) {
                distributionChart.destroy();
            }

            const labels = data.map(d => d.category);
            const values = data.map(d => d.value);
            const colors = [
                'rgba(0, 212, 255, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(239, 68, 68, 0.8)'
            ];

            distributionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'rgba(255, 255, 255, 0.8)' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderExpensesChart(data) {
            const ctx = document.getElementById('expensesChart');
            if (!ctx) return;

            if (expensesChart) {
                expensesChart.destroy();
            }

            // Limitar a 10 primeiros para melhor visualiza√ß√£o
            const limitedData = data.slice(0, 10);
            const labels = limitedData.map(d => d.contract_name.length > 20 ? d.contract_name.substring(0, 20) + '...' : d.contract_name);
            const values = limitedData.map(d => d.despesa_mensal);

            expensesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Despesa Mensal (R$)',
                        data: values,
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(255, 255, 255, 0.8)' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.6)',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function renderExpirationsTable(data) {
            const tbody = document.getElementById('expirationsTableBody');
            if (!tbody) return;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">Nenhum vencimento pr√≥ximo</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const statusBadge = {
                    'critical': '<span style="color: #ef4444; font-weight: bold;">üî¥ Cr√≠tico</span>',
                    'warning': '<span style="color: #f59e0b; font-weight: bold;">‚ö†Ô∏è Aten√ß√£o</span>',
                    'normal': '<span style="color: #10b981;">‚ÑπÔ∏è Normal</span>'
                }[item.status] || '<span>‚ÑπÔ∏è Normal</span>';

                const expirationDate = item.expiration_date ? new Date(item.expiration_date).toLocaleDateString('pt-BR') : '-';

                return `
                    <tr>
                        <td>${item.contract_name}</td>
                        <td style="text-align: center;">${expirationDate}</td>
                        <td style="text-align: center;">${item.days_until_expiration} dias</td>
                        <td style="text-align: center;">${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        window.onload = loadDashboard;
    </script>

    <!-- Modal de Acesso Negado -->
    <div id="accessDeniedModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div class="glass-card" style="max-width: 500px; margin: 20px; padding: 32px; position: relative;">
            <button type="button" onclick="closeAccessDeniedModal()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 24px; line-height: 1;">
                &times;
            </button>

            <div style="text-align: center; margin-bottom: 24px;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="margin: 0 auto 16px;">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                <h2 id="modalTitle" style="font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: var(--text-primary); margin-bottom: 12px;">Acesso Negado</h2>
                <p id="modalMessage" style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 24px;">Voc√™ precisa de uma assinatura ativa para acessar a calculadora.</p>
            </div>

            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button type="button" id="modalActionBtn" class="btn-neon" style="flex: 1; min-width: 200px;">
                    Ver Planos e Assinar
                </button>
                <button type="button" onclick="closeAccessDeniedModal()" class="btn-neon-outline" style="flex: 0 0 auto;">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Session Manager para controle de sess√µes simult√¢neas -->
    <script src="assets/js/session-manager.js"></script>
</body>
</html>

