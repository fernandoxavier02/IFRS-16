<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Engine IFRS 16</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/theme-neon.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            z-index: 10;
        }
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .header-brand img {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.4));
        }
        .header-brand h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-brand p {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .header-actions {
            display: flex;
            gap: 12px;
        }
        .value-card {
            background: linear-gradient(135deg, var(--dark-card) 0%, rgba(10, 22, 40, 0.9) 100%);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .value-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--card-accent);
        }
        .value-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 212, 255, 0.15);
        }
        .value-card.cyan { 
            --card-accent: linear-gradient(90deg, var(--neon-blue), var(--neon-cyan)); 
            border: 1px solid rgba(0, 212, 255, 0.2);
        }
        .value-card.purple { 
            --card-accent: linear-gradient(90deg, var(--neon-purple), var(--neon-magenta)); 
            border: 1px solid rgba(184, 41, 221, 0.2);
        }
        .value-card.amber { 
            --card-accent: linear-gradient(90deg, #f59e0b, #fbbf24); 
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        .value-card .label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .value-card .value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
        }
        .value-card.cyan .value { color: var(--neon-cyan); }
        .value-card.purple .value { color: var(--neon-purple); }
        .value-card.amber .value { color: #fbbf24; }
        .value-card .sub {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 8px;
        }
        .license-key {
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.15em;
            font-size: 1.2rem;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        .license-box {
            background: rgba(10, 14, 23, 0.8);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .info-item .label {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        .info-item .value {
            color: var(--text-primary);
            font-weight: 500;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .badge-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .features-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .feature-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 212, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.1);
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .feature-item svg {
            flex-shrink: 0;
            color: var(--neon-cyan);
        }
        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .btn-danger {
            background: transparent;
            border: 1px solid rgba(255, 68, 102, 0.5);
            color: var(--error);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background: rgba(255, 68, 102, 0.1);
            border-color: var(--error);
        }
        .loading-spinner {
            text-align: center;
            padding: 80px 20px;
        }
        .loading-spinner .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--dark-border);
            border-top-color: var(--neon-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Circuit Background -->
    <div class="circuit-bg"></div>

    <div class="dashboard-container fade-in">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-brand">
                <img src="logo/Gemini_Generated_Image_rvkfr5rvkfr5rvkf.png" alt="FX Studio AI">
                <div>
                    <h1>Minha Conta</h1>
                    <p>Gerencie sua assinatura e licen√ßa</p>
                </div>
            </div>
            <div class="header-actions">
                <button type="button" id="btnCalculator" onclick="accessCalculator()" class="btn-neon btn-neon-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 9h6v6H9z"/></svg>
                    Calculadora
                </button>
                <button type="button" onclick="logout()" class="btn-neon-outline btn-neon-sm">Sair</button>
            </div>
        </header>

        <!-- Loading -->
        <div id="loading" class="loading-spinner">
            <div class="spinner"></div>
            <p style="color: var(--text-secondary);">Carregando...</p>
        </div>

        <!-- Content -->
        <div id="content" style="display: none;">
            <!-- User Info -->
            <div class="glass-card" style="padding: 24px; margin-bottom: 24px;">
                <h2 class="section-title">Informa√ß√µes da Conta</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <p class="label">Nome</p>
                        <p id="userName" class="value">-</p>
                    </div>
                    <div class="info-item">
                        <p class="label">Email</p>
                        <p id="userEmail" class="value">-</p>
                    </div>
                </div>
            </div>

            <!-- Subscription Cards -->
            <div class="cards-grid">
                <div class="value-card cyan">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <p class="label">Status da Assinatura</p>
                        <span id="statusBadge" class="badge badge-success" style="display: none;">Ativa</span>
                    </div>
                    <p id="subStatus" class="value">-</p>
                    <p id="subPlan" class="sub">-</p>
                </div>
                <div class="value-card purple">
                    <p class="label">Pr√≥xima Renova√ß√£o</p>
                    <p id="subRenewal" class="value">-</p>
                    <p id="subCancelNote" class="sub" style="display: none; color: var(--warning);">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="display: inline-block; margin-right: 4px; vertical-align: middle;">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        Ser√° cancelada ao fim do per√≠odo
                    </p>
                </div>
                <div class="value-card amber">
                    <p class="label">Limites do Plano</p>
                    <p id="contractsLimit" class="value">0/0</p>
                    <p class="sub">Contratos utilizados</p>
                    <div id="usageBar" style="margin-top: 12px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 6px; overflow: hidden;">
                            <div id="usageProgress" style="background: linear-gradient(90deg, #f59e0b, #fbbf24); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscription Details Card (s√≥ aparece se tiver assinatura ativa) -->
            <div id="subscriptionDetails" class="glass-card" style="padding: 24px; margin-bottom: 24px; display: none;">
                <h2 class="section-title">Detalhes da Assinatura</h2>
                <div class="info-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="info-item">
                        <p class="label">Plano Atual</p>
                        <p id="planName" class="value">-</p>
                    </div>
                    <div class="info-item">
                        <p class="label">Per√≠odo Atual</p>
                        <p id="currentPeriod" class="value">-</p>
                    </div>
                    <div class="info-item">
                        <p class="label">ID da Assinatura</p>
                        <p id="stripeSubId" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-secondary);">-</p>
                    </div>
                    <div class="info-item">
                        <p class="label">Criada em</p>
                        <p id="createdAt" class="value">-</p>
                    </div>
                </div>

                <!-- Features do Plano -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">Recursos Inclu√≠dos</h3>
                    <div id="planFeatures" class="features-list"></div>
                </div>
            </div>

            <!-- License Card -->
            <div class="glass-card" style="padding: 24px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h2 class="section-title" style="margin-bottom: 0;">Sua Chave de Licen√ßa</h2>
                    <button onclick="copyLicenseKey()" id="copyBtn" class="btn-neon-outline btn-neon-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        Copiar
                    </button>
                </div>
                
                <div id="licenseArea" class="license-box">
                    <p id="licenseKey" class="license-key">-</p>
                    <p id="licenseType" style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">-</p>
                    <p id="licenseExpires" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px;">-</p>
                </div>

                <div id="noLicense" style="display: none; text-align: center; padding: 40px 20px;">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Voc√™ ainda n√£o tem uma licen√ßa ativa.</p>
                    <a href="landing.html#pricing" class="btn-neon">Ver Planos</a>
                </div>
            </div>

            <!-- Actions -->
            <div class="glass-card" style="padding: 24px;">
                <h2 class="section-title">Gerenciar Assinatura</h2>
                <div class="actions-row">
                    <button onclick="openPortal()" id="portalBtn" class="btn-neon-outline btn-neon-sm" style="display: none;">
                        Gerenciar Pagamento
                    </button>
                    <button onclick="subscribeToPlan()" id="upgradeBtn" class="btn-neon btn-neon-sm" style="display: none;">
                        Assinar Plano
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const getApiUrl = () => {
            const hostname = window.location.hostname;

            if (
                hostname.includes('fxstudioai.com') ||
                hostname.includes('web.app') ||
                hostname.includes('firebaseapp.com')
            ) {
                return 'https://ifrs16-backend-1051753255664.us-central1.run.app';
            }

            return 'http://localhost:8000';
        };

        const API_URL = getApiUrl();
        let dashboardData = null;

        // Formatar nome do plano
        function formatPlanName(planType) {
            const names = {
                'basic_monthly': 'B√°sico Mensal',
                'basic_yearly': 'B√°sico Anual',
                'pro_monthly': 'Pro Mensal',
                'pro_yearly': 'Pro Anual',
                'enterprise_monthly': 'Enterprise Mensal',
                'enterprise_yearly': 'Enterprise Anual'
            };
            return names[planType] || planType;
        }

        // Obter limites do plano
        function getPlanLimits(planType) {
            const limits = {
                'basic_monthly': { max_contracts: 5, features: ['Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Email'] },
                'basic_yearly': { max_contracts: 5, features: ['Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Email'] },
                'pro_monthly': { max_contracts: 20, features: ['Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Priorit√°rio', 'API Access'] },
                'pro_yearly': { max_contracts: 20, features: ['Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Priorit√°rio', 'API Access'] },
                'enterprise_monthly': { max_contracts: -1, features: ['Contratos Ilimitados', 'Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Dedicado', 'API Access', 'Treinamento', 'SLA'] },
                'enterprise_yearly': { max_contracts: -1, features: ['Contratos Ilimitados', 'Excel Export', 'CSV Export', 'PDF Export', 'Relat√≥rios', 'Suporte Dedicado', 'API Access', 'Treinamento', 'SLA'] }
            };
            return limits[planType] || { max_contracts: 0, features: [] };
        }

        // Renderizar features do plano
        function renderPlanFeatures(planLimits) {
            const container = document.getElementById('planFeatures');
            container.innerHTML = '';

            planLimits.features.forEach(feature => {
                const featureEl = document.createElement('div');
                featureEl.className = 'feature-item';
                featureEl.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    <span>${feature}</span>
                `;
                container.appendChild(featureEl);
            });
        }

        async function loadDashboard() {
            const token = localStorage.getItem('ifrs16_auth_token');
            
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                // Carregar perfil do usu√°rio
                const profileResponse = await fetch(`${API_URL}/api/user/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (profileResponse.status === 401) {
                    localStorage.removeItem('ifrs16_auth_token');
                    window.location.href = 'login.html';
                    return;
                }

                const profile = await profileResponse.json();

                // Carregar assinatura
                const subscriptionResponse = await fetch(`${API_URL}/api/user/subscription`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let subscription = null;
                if (subscriptionResponse.ok) {
                    subscription = await subscriptionResponse.json();
                    console.log('üìä Dados da assinatura recebidos:', subscription);
                } else {
                    console.warn('‚ö†Ô∏è Erro ao buscar assinatura:', subscriptionResponse.status);
                }

                // A API agora retorna contracts_count dentro de subscription
                const contractsCount = subscription?.contracts_count || 0;

                dashboardData = {
                    user: profile,
                    subscription: subscription,
                    license: subscription?.license || null,
                    stats: {
                        total_validations: 0,
                        contracts_count: contractsCount
                    }
                };

                console.log('üìã Dashboard data final:', dashboardData);
                renderDashboard();
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: var(--error);">Erro ao carregar dados. <button onclick="loadDashboard()" class="btn-neon-outline btn-neon-sm">Tentar novamente</button></p>
                `;
            }
        }

        function renderDashboard() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // User info
            document.getElementById('userName').textContent = dashboardData.user.name;
            document.getElementById('userEmail').textContent = dashboardData.user.email;

            // Adicionar empresa se existir
            if (dashboardData.user.company_name) {
                const emailItem = document.querySelector('#userEmail').parentElement;
                const companyItem = document.createElement('div');
                companyItem.className = 'info-item';
                companyItem.innerHTML = `
                    <p class="label">Empresa</p>
                    <p class="value">${dashboardData.user.company_name}</p>
                `;
                emailItem.parentElement.appendChild(companyItem);
            }

            // Stats
            // TODO: Adicionar elemento totalValidations no HTML se necess√°rio
            // document.getElementById('totalValidations').textContent = dashboardData.stats.total_validations;

            // Subscription
            console.log('üîç Verificando assinatura:', {
                hasSubscription: !!dashboardData.subscription,
                status: dashboardData.subscription?.status,
                plan_type: dashboardData.subscription?.plan_type
            });

            if (dashboardData.subscription && dashboardData.subscription.status === 'active') {
                const sub = dashboardData.subscription;
                console.log('‚úÖ Assinatura ativa detectada, renderizando dados...');

                // Status Badge
                const badge = document.getElementById('statusBadge');
                badge.style.display = 'inline-block';
                badge.className = 'badge badge-success';
                badge.textContent = 'Ativa';

                document.getElementById('subStatus').textContent = 'Ativa';
                document.getElementById('subPlan').textContent = formatPlanName(sub.plan_type);

                // Renova√ß√£o
                if (sub.current_period_end) {
                    const endDate = new Date(sub.current_period_end);
                    document.getElementById('subRenewal').textContent = endDate.toLocaleDateString('pt-BR');

                    // Aviso se cancelar ao fim do per√≠odo
                    if (sub.cancel_at_period_end) {
                        document.getElementById('subCancelNote').style.display = 'block';
                    }
                } else {
                    document.getElementById('subRenewal').textContent = 'Vital√≠cio';
                }

                // Limites do plano
                const planLimits = getPlanLimits(sub.plan_type);
                const contractsUsed = dashboardData.stats.contracts_count || 0;
                document.getElementById('contractsLimit').textContent = `${contractsUsed}/${planLimits.max_contracts === -1 ? '‚àû' : planLimits.max_contracts}`;

                // Barra de progresso
                if (planLimits.max_contracts > 0) {
                    const usagePercent = (contractsUsed / planLimits.max_contracts) * 100;
                    document.getElementById('usageBar').style.display = 'block';
                    document.getElementById('usageProgress').style.width = `${Math.min(usagePercent, 100)}%`;

                    // Mudar cor se pr√≥ximo do limite
                    if (usagePercent >= 90) {
                        document.getElementById('usageProgress').style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                    } else if (usagePercent >= 70) {
                        document.getElementById('usageProgress').style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                    }
                }

                // Detalhes da assinatura
                document.getElementById('subscriptionDetails').style.display = 'block';
                document.getElementById('planName').textContent = formatPlanName(sub.plan_type);

                if (sub.current_period_start && sub.current_period_end) {
                    const start = new Date(sub.current_period_start).toLocaleDateString('pt-BR');
                    const end = new Date(sub.current_period_end).toLocaleDateString('pt-BR');
                    document.getElementById('currentPeriod').textContent = `${start} - ${end}`;
                }

                document.getElementById('stripeSubId').textContent = sub.stripe_subscription_id || '-';

                if (sub.created_at) {
                    document.getElementById('createdAt').textContent = new Date(sub.created_at).toLocaleDateString('pt-BR');
                }

                // Features do plano
                renderPlanFeatures(planLimits);

                document.getElementById('portalBtn').style.display = 'inline-flex';
            } else {
                // Sem assinatura ativa
                const badge = document.getElementById('statusBadge');
                badge.style.display = 'inline-block';
                badge.className = 'badge badge-error';
                badge.textContent = 'Inativa';

                document.getElementById('subStatus').textContent = 'Inativa';
                document.getElementById('subPlan').textContent = 'Sem assinatura';
                document.getElementById('subRenewal').textContent = '-';
                document.getElementById('contractsLimit').textContent = '0/0';
                document.getElementById('upgradeBtn').style.display = 'inline-flex';
                document.getElementById('portalBtn').style.display = 'none';
                document.getElementById('subscriptionDetails').style.display = 'none';
            }

            // License
            if (dashboardData.license) {
                const lic = dashboardData.license;
                document.getElementById('licenseKey').textContent = lic.key;
                document.getElementById('licenseType').textContent = `Licen√ßa ${lic.type.toUpperCase()}`;
                
                if (lic.expires_at) {
                    const expDate = new Date(lic.expires_at);
                    document.getElementById('licenseExpires').textContent = `V√°lida at√© ${expDate.toLocaleDateString('pt-BR')}`;
                } else {
                    document.getElementById('licenseExpires').textContent = 'Licen√ßa vital√≠cia';
                }

                document.getElementById('licenseArea').style.display = 'block';
                document.getElementById('noLicense').style.display = 'none';
            } else {
                document.getElementById('licenseArea').style.display = 'none';
                document.getElementById('noLicense').style.display = 'block';
            }
        }

        function copyLicenseKey() {
            const key = document.getElementById('licenseKey').textContent;
            navigator.clipboard.writeText(key).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Copiado!';
                setTimeout(() => {
                    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> Copiar';
                }, 2000);
            });
        }

        async function openPortal() {
            const token = localStorage.getItem('ifrs16_auth_token');

            try {
                // ‚úì ATUALIZADO: usar /api/payments/portal ao inv√©s de /api/stripe/create-portal-session
                const response = await fetch(`${API_URL}/api/payments/portal`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    window.location.href = data.portal_url;  // ‚úì ATUALIZADO: portal_url ao inv√©s de url
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Erro ao abrir portal de pagamento');
                }
            } catch (error) {
                alert('Erro de conex√£o');
            }
        }

        async function subscribeToPlan() {
            // Redirecionar para p√°gina de pre√ßos
            window.location.href = 'landing.html#pricing';
        }

        function logout() {
            localStorage.removeItem('ifrs16_auth_token');
            localStorage.removeItem('ifrs16_user_type');
            window.location.href = 'login.html';
        }

        // Verificar acesso √† calculadora
        function accessCalculator() {
            // Verificar se tem assinatura ativa
            if (!dashboardData.subscription) {
                showAccessDeniedModal('sem_assinatura');
                return;
            }

            // Verificar se tem licen√ßa
            if (!dashboardData.license) {
                showAccessDeniedModal('sem_licenca');
                return;
            }

            // Verificar se a licen√ßa est√° ativa
            if (dashboardData.license.status !== 'active') {
                showAccessDeniedModal('licenca_inativa');
                return;
            }

            // Verificar se a assinatura est√° ativa
            if (dashboardData.subscription.status !== 'active') {
                showAccessDeniedModal('assinatura_inativa');
                return;
            }

            // Tudo OK, permitir acesso
            window.location.href = 'Calculadora_IFRS16_Deploy.html';
        }

        // Mostrar modal de acesso negado
        function showAccessDeniedModal(reason) {
            const modal = document.getElementById('accessDeniedModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            const actionBtn = document.getElementById('modalActionBtn');

            let titleText = '';
            let messageText = '';
            let buttonText = 'Ver Planos e Assinar';
            let buttonAction = () => window.location.href = 'landing.html#pricing';

            switch(reason) {
                case 'sem_assinatura':
                    titleText = 'Assinatura Necess√°ria';
                    messageText = 'Para acessar a calculadora IFRS 16, voc√™ precisa ter uma assinatura ativa. Escolha o plano ideal para suas necessidades e comece a usar agora!';
                    break;
                case 'sem_licenca':
                    titleText = 'Licen√ßa N√£o Encontrada';
                    messageText = 'Sua assinatura est√° ativa, mas a licen√ßa ainda n√£o foi gerada. Por favor, entre em contato com o suporte ou tente novamente em alguns minutos.';
                    buttonText = 'Entrar em Contato';
                    buttonAction = () => window.location.href = 'mailto:contato@fxstudioai.com';
                    break;
                case 'licenca_inativa':
                    titleText = 'Licen√ßa Inativa';
                    messageText = 'Sua licen√ßa n√£o est√° ativa. Isso pode acontecer se sua assinatura expirou ou foi cancelada. Renove sua assinatura para continuar usando a calculadora.';
                    break;
                case 'assinatura_inativa':
                    titleText = 'Assinatura Inativa';
                    messageText = 'Sua assinatura n√£o est√° ativa. Por favor, renove sua assinatura para ter acesso √† calculadora IFRS 16.';
                    break;
            }

            title.textContent = titleText;
            message.textContent = messageText;
            actionBtn.textContent = buttonText;
            actionBtn.onclick = buttonAction;

            modal.style.display = 'flex';
        }

        // Fechar modal
        function closeAccessDeniedModal() {
            document.getElementById('accessDeniedModal').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('accessDeniedModal');
            if (event.target === modal) {
                closeAccessDeniedModal();
            }
        }

        // Inicializar
        window.onload = loadDashboard;
    </script>

    <!-- Modal de Acesso Negado -->
    <div id="accessDeniedModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div class="glass-card" style="max-width: 500px; margin: 20px; padding: 32px; position: relative;">
            <button type="button" onclick="closeAccessDeniedModal()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 24px; line-height: 1;">
                &times;
            </button>

            <div style="text-align: center; margin-bottom: 24px;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="margin: 0 auto 16px;">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                <h2 id="modalTitle" style="font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: var(--text-primary); margin-bottom: 12px;">Acesso Negado</h2>
                <p id="modalMessage" style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 24px;">Voc√™ precisa de uma assinatura ativa para acessar a calculadora.</p>
            </div>

            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button type="button" id="modalActionBtn" class="btn-neon" style="flex: 1; min-width: 200px;">
                    Ver Planos e Assinar
                </button>
                <button type="button" onclick="closeAccessDeniedModal()" class="btn-neon-outline" style="flex: 0 0 auto;">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</body>
</html>

